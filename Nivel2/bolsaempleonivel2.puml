@startuml Nivel 2
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Bolsa de Empleo - Nivel 2 (Contenedores) (DB unica)

LAYOUT_TOP_DOWN()
skinparam shadowing false
skinparam wrapWidth 180
skinparam maxMessageSize 60

Person(candidato, "Usuario / Candidato", "Busca vacantes, postula y gestiona CV")

System_Boundary(s1, "Bolsa de Empleo") {

  ' ===== Capa UI =====
  Container(spa, "Web SPA", "React", "UI de búsqueda, postulaciones, CV, recomendaciones")

  ' ===== Capa Entrada =====
  Container(gateway, "API Gateway / BFF", "Backend", "Valida JWT, rate limit, logs, ruteo")

  ' ===== Capa Servicios =====
  Container(auth, "MS-Auth", "Microservicio", "Login, registro, JWT, roles")
  Container(cv, "MS-CV", "Microservicio", "Gestión hoja de vida, CV")
  Container(jobs, "MS-Jobs", "Microservicio", "Persistencia y consulta de ofertas")
  Container(matching, "MS-Matching", "Microservicio", "Score, brechas, análisis CV vs oferta")
  Container(reco, "MS-Recomendación", "Microservicio", "Recomienda vacantes y plan de estudio")
  Container(scraping, "MS-Scraping", "Microservicio", "Integra fuentes, extrae/publica ofertas")

  ' ===== Broker =====
  ContainerQueue(broker, "Message Broker", "RabbitMQ/Kafka/Redis Streams", "Eventos entre servicios")

  ' ===== Capa Datos (UNICA) =====
  ContainerDb(mainDb, "bolsa_empleo_db", "PostgreSQL", "Autenticación, CV, ofertas, matching y recomendaciones")
}

' ===== Externos =====
System_Ext(linkedin, "LinkedIn", "Bolsa externa")
System_Ext(compu, "CompuTrabajo", "Bolsa externa")
System_Ext(storage, "Object Storage", "S3/MinIO (opcional)")
System_Ext(wordpdf, "Motor PDF/Word", "LibreOffice/Docx/PDF (opcional)")

' ===== Flujo principal =====
Rel(candidato, spa, "Usa", "HTTPS")
Rel(spa, gateway, "API", "HTTPS/JSON")

Rel(gateway, auth, "Auth/roles", "REST")
Rel(gateway, cv, "CV", "REST")
Rel(gateway, jobs, "Ofertas", "REST")
Rel(gateway, matching, "Matching", "REST")
Rel(gateway, reco, "Recomendación", "REST")
Rel(gateway, scraping, "Admin scraping (opcional)", "REST")

' ===== DB unica =====
Rel(auth, mainDb, "Lee/Escribe")
Rel(cv, mainDb, "Lee/Escribe")
Rel(jobs, mainDb, "Lee/Escribe")
Rel(matching, mainDb, "Lee/Escribe")
Rel(reco, mainDb, "Lee/Escribe")
Rel(scraping, mainDb, "Lee/Escribe")

' ===== Externos =====
Rel(cv, storage, "Guarda/lee certificados", "S3 API")
Rel(cv, wordpdf, "Genera PDF/Word", "HTTP/CLI")
Rel(scraping, linkedin, "Extrae/Publica", "API/Scraping")
Rel(scraping, compu, "Extrae/Publica", "API/Scraping")

' ===== Eventos =====
Rel(scraping, broker, "Publica: JobFetched/JobUpdated")
Rel(jobs, broker, "Consume Job*; Publica JobIndexed")
Rel(cv, broker, "Publica: CVUpdated")
Rel(matching, broker, "Consume CV* + JobIndexed; Publica MatchComputed/GapDetected")
Rel(reco, broker, "Consume Match*; Publica RecommendationReady")

' ===== Alineación por capas =====
Lay_Down(spa, gateway)
Lay_Down(gateway, auth)
Lay_Down(gateway, cv)
Lay_Down(gateway, jobs)
Lay_Down(gateway, matching)
Lay_Down(gateway, reco)
Lay_Down(gateway, scraping)

Lay_Down(auth, mainDb)
Lay_Down(cv, mainDb)
Lay_Down(jobs, mainDb)
Lay_Down(matching, mainDb)
Lay_Down(reco, mainDb)
Lay_Down(scraping, mainDb)

SHOW_LEGEND()
@enduml
